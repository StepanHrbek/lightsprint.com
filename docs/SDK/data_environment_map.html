<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LightsprintSDK: Environment map</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">LightsprintSDK<span id="projectnumber">&#160;2021.08.08</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('data_environment_map.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Environment map</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Environment map (cube texture) is designed for global illumination of single object.</p>
<h1><a class="anchor" id="d31"></a>
Suitable for</h1>
<ul>
<li>static objects: YES</li>
<li>dynamic objects: YES</li>
<li>realtime calculated illumination: YES</li>
<li>precalculated illumination: YES</li>
</ul>
<h1><a class="anchor" id="d32"></a>
Advantages</h1>
<ul>
<li>offers global illumination with both specular and diffuse reflections</li>
<li>object doesn't have to be part of static scene, no <a class="el" href="classrr_1_1_r_r_object.html" title="Common interface for all proprietary object formats.">RRObject</a> adapter is required</li>
<li>calculation is independent to object complexity, quick even for extremely complex objects</li>
</ul>
<h1><a class="anchor" id="d33"></a>
Disadvantages</h1>
<ul>
<li>precision decreases with size of object, suitable for characters and items, not for buildings</li>
<li>complexity of objects doesn't matter, but count of environment map updates does, so if you need large clouds/crowds of dynamic objects visible all at once, share one environment map for several close objects and update it only once to save time</li>
</ul>
<h1><a class="anchor" id="d35"></a>
Interface, implementations</h1>
<ul>
<li><a class="el" href="classrr_1_1_r_r_buffer.html" title="Buffer, array of elements.">RRBuffer</a></li>
</ul>
<h1><a class="anchor" id="d34"></a>
Instances</h1>
<ul>
<li>stored in: RRObjectIllumination::diffuseEnvMap and RRObjectIllumination::specularEnvMap or your arbitrary location</li>
<li>created by: <a class="el" href="classrr_1_1_r_r_solver.html#aaf0703d3ee895467659bbf3ebd9e198c" title="Allocates buffers for realtime GI illumination of objects in solver.">RRSolver::allocateBuffersForRealtimeGI()</a> or allocate and assign buffers yourself</li>
<li>updated by: <a class="el" href="classrr_1_1_r_r_solver.html#a430bb0184e06c57877d821ea26e02bf3" title="Calculates and updates object&#39;s environment map, stored in given layer of given illumination.">RRSolver::updateEnvironmentMap()</a> or <a class="el" href="classrr_1_1_r_r_light_field.html#a3fcd2fad1f7a19cc25817a097487b736" title="Updates diffuse and/or specular environment maps in object illumination.">RRLightField::updateEnvironmentMap()</a></li>
</ul>
<h1><a class="anchor" id="d36"></a>
Rendering</h1>
<ul>
<li>Many rendering techniques are based on faked precomputed environment maps. Here you get realtime computed environment maps, and you are free to use them for any purpose.</li>
<li>Request environment (cube) map to be generated in center of your object. Environment map may be later used by GPU to add global illumination to diffuse and specular surfaces close to given point in space.</li>
<li>We propose you several techniques: <br  />
 For rough surface with mostly <b>diffuse</b> reflection, read value from environment map's small mip level, using 'surface normal' as a coordinate. This single texture lookup gives you global illumination of pixel. Multiply it by material diffuse color to get final color. <br  />
 For smooth surface with <b>specular</b> reflection, read value from environment map, using 'eye direction reflected by surface' as a coordinate. Use smaller or larger mip level based on material <b>shininess</b>. This single texture lookup gives you global illumination of pixel. Don't modulate it by material color unless you want to render exotic materials, you already have final color. Size 16 of environment map is often good compromise between environment update speed and reflection sharpness. <br  />
 You can use <b>normal map</b> or <b>height map</b> to modulate surface normal. Both diffuse and specular surfaces respond well to bump maps. <br  />
 LightsprintGL implements all of these techniques.</li>
<li>Global illumination can be further improved if you use <b>ambient occlusion map</b> for your dynamic object. Multiply global illumination read from environment map by ambient occlusion read from ambient occlusion map to get more precise result. Ambient occlusion maps are computed for example by BuildLightmaps sample.</li>
</ul>
<h1><a class="anchor" id="d37"></a>
Examples</h1>
<ul>
<li>OpenGL example: <br  />
 Rendering with environment maps. <div class="fragment"><div class="line"><a class="code hl_class" href="classrr_1_1_r_r_solver.html">rr::RRSolver</a>* solver;</div>
<div class="line"><a class="code hl_class" href="classrr_1_1_r_r_object_illumination.html">rr::RRObjectIllumination</a>* illumination;</div>
<div class="line">GLuint program;</div>
<div class="line">...</div>
<div class="line"><span class="comment">// update environment maps</span></div>
<div class="line">solver-&gt;updateEnvironmentMap(illumination);</div>
<div class="line"><span class="comment">// set program created from shader below</span></div>
<div class="line">glUseProgram(program);</div>
<div class="line"><span class="comment">// bind diffuse environment map to texture0</span></div>
<div class="line"><span class="comment">// it calls glBindTexture(GL_TEXTURE_2D,map);</span></div>
<div class="line">glActiveTexture(GL_TEXTURE0);</div>
<div class="line"><a class="code hl_function" href="namespacerr__gl.html#a3519646a7143ca3ecccf5e365260b390">rr_gl::getTexture</a>(illumination-&gt;diffuseEnvMap)-&gt;<a class="code hl_function" href="classrr__gl_1_1_texture.html#af6680007aa9cc0f45538e80eb6fb53e8">bindTexture</a>();</div>
<div class="line"><span class="comment">// set sampler to use texture0</span></div>
<div class="line">glUniform1i(glGetUniformLocation(program,<span class="stringliteral">&quot;diffuseEnvironmentMap&quot;</span>),0);</div>
<div class="line"><span class="comment">// bind specular environment map to texture1</span></div>
<div class="line">glActiveTexture(GL_TEXTURE1);</div>
<div class="line"><a class="code hl_function" href="namespacerr__gl.html#a3519646a7143ca3ecccf5e365260b390">rr_gl::getTexture</a>(illumination-&gt;specularEnvMap)-&gt;<a class="code hl_function" href="classrr__gl_1_1_texture.html#af6680007aa9cc0f45538e80eb6fb53e8">bindTexture</a>();</div>
<div class="line"><span class="comment">// set sampler to use texture1</span></div>
<div class="line">glUniform1i(glGetUniformLocation(program,<span class="stringliteral">&quot;specularEnvironmentMap&quot;</span>),1);</div>
<div class="line"><span class="comment">// render primitives</span></div>
<div class="line">glDrawElements...</div>
<div class="ttc" id="aclassrr_1_1_r_r_object_illumination_html"><div class="ttname"><a href="classrr_1_1_r_r_object_illumination.html">rr::RRObjectIllumination</a></div><div class="ttdoc">Data structure with object's illumination and more.</div><div class="ttdef"><b>Definition</b> RRIllumination.h:40</div></div>
<div class="ttc" id="aclassrr_1_1_r_r_solver_html"><div class="ttname"><a href="classrr_1_1_r_r_solver.html">rr::RRSolver</a></div><div class="ttdoc">Global illumination solver for interactive applications.</div><div class="ttdef"><b>Definition</b> RRSolver.h:58</div></div>
<div class="ttc" id="aclassrr__gl_1_1_texture_html_af6680007aa9cc0f45538e80eb6fb53e8"><div class="ttname"><a href="classrr__gl_1_1_texture.html#af6680007aa9cc0f45538e80eb6fb53e8">rr_gl::Texture::bindTexture</a></div><div class="ttdeci">void bindTexture() const</div><div class="ttdoc">Binds texture.</div></div>
<div class="ttc" id="anamespacerr__gl_html_a3519646a7143ca3ecccf5e365260b390"><div class="ttname"><a href="namespacerr__gl.html#a3519646a7143ca3ecccf5e365260b390">rr_gl::getTexture</a></div><div class="ttdeci">RR_GL_API Texture * getTexture(const rr::RRBuffer *buffer, bool buildMipMaps=true, bool compress=true, int magn=GL_LINEAR, int mini=GL_LINEAR, int wrapS=GL_REPEAT, int wrapT=GL_REPEAT)</div><div class="ttdoc">Converts rr::RRBuffer to Texture so it can be immediately used as a texture in OpenGL.</div></div>
</div><!-- fragment --> Applying environment maps in GLSL fragment shader: <div class="fragment"><div class="line">uniform samplerCube specularEnvironmentMap;</div>
<div class="line">uniform samplerCube diffuseEnvironmentMap;</div>
<div class="line"><span class="keywordtype">void</span> fragmentShader()</div>
<div class="line">{</div>
<div class="line">        <span class="comment">// normal in world space, you may apply normal map here</span></div>
<div class="line">        vec3 worldNormal = ...;</div>
<div class="line">        <span class="comment">// view vector in world space = position of fragment - position of camera</span></div>
<div class="line">        vec3 worldView = ...;</div>
<div class="line">        <span class="comment">// reflected view vector in world space</span></div>
<div class="line">        vec3 worldViewReflected = reflect(worldView,worldNormal);</div>
<div class="line">        ...</div>
<div class="line">        gl_FragColor = ...</div>
<div class="line">                <span class="comment">// diffuse reflection</span></div>
<div class="line">                + materialDiffuseReflectance *</div>
<div class="line">                  textureCube(diffuseEnvironmentMap, worldNormal)</div>
<div class="line">                <span class="comment">// specular reflection</span></div>
<div class="line">                + materialSpecularReflectance *</div>
<div class="line">                  textureCube(specularEnvironmentMap, worldViewReflected);</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Direct3D 9 example: <br  />
 Rendering with environment maps. <div class="fragment"><div class="line">IDirect3DDevice9* device;</div>
<div class="line">IDirect3DPixelShader9* pixelShader;</div>
<div class="line"><a class="code hl_class" href="classrr_1_1_r_r_solver.html">rr::RRSolver</a>* solver;</div>
<div class="line"><a class="code hl_class" href="classrr_1_1_r_r_object_illumination.html">rr::RRObjectIllumination</a>* illumination;</div>
<div class="line">...</div>
<div class="line"><span class="comment">// update environment maps</span></div>
<div class="line">solver-&gt;updateEnvironmentMap(illumination);</div>
<div class="line"><span class="comment">// set rendering pipeline to use shader below</span></div>
<div class="line">device-&gt;SetPixelShader(pixelShader);</div>
<div class="line"><span class="comment">// set samplers to use environment maps</span></div>
<div class="line">...</div>
<div class="line"><span class="comment">// render primitives</span></div>
<div class="line">device-&gt;DrawPrimitive...</div>
</div><!-- fragment --> Applying environment maps in HLSL pixel shader: <div class="fragment"><div class="line">samplerCUBE specularEnvironmentMap;</div>
<div class="line">samplerCUBE diffuseEnvironmentMap;</div>
<div class="line"><span class="keywordtype">void</span> pixelShader(..., out float4 oColor: COLOR)</div>
<div class="line">{</div>
<div class="line">        <span class="comment">// normal in world space, you may apply normal map here</span></div>
<div class="line">        float3 worldNormal = ...;</div>
<div class="line">        <span class="comment">// view vector in world space = position of fragment - position of camera</span></div>
<div class="line">        float3 worldView = ...;</div>
<div class="line">        <span class="comment">// reflected view vector in world space</span></div>
<div class="line">        float3 worldViewReflected = reflect(worldView,worldNormal);</div>
<div class="line">        ...</div>
<div class="line">        oColor = ...</div>
<div class="line">                <span class="comment">// diffuse reflection</span></div>
<div class="line">                + materialDiffuseReflectance *</div>
<div class="line">                  texCUBE(diffuseEnvironmentMap, worldNormal)</div>
<div class="line">                <span class="comment">// specular reflection</span></div>
<div class="line">                + materialSpecularReflectance *</div>
<div class="line">                  texCUBE(specularEnvironmentMap, worldViewReflected);</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>See Direct3D, OpenGL or your engine documentation for more details on texturemapping and applying environment maps. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">index</a></li><li class="navelem"><a class="el" href="main_data_access.html">Calculation and outputs</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7 </li>
  </ul>
</div>
</body>
</html>
